<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <title>Lifecycle | Moleculer Go - Progressive microservices framework in Go</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="microservices, nodejs, node.js, javascript, github, opensource, framework, moleculer, github, scaling">
  <meta name="description" content="Moleculer is a fast, scalable and powerful microservices framework for Node.js.">
  <meta name="robots" content="index, follow">
  <!-- Canonical links -->
  <link rel="canonical" href="https://gomicro.services/docs/0.1/lifecycle.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="en" href="https://gomicro.services/docs/0.1/lifecycle.html">
    
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <!-- CSS -->
  <!-- build:css build/css/moleculer.css -->
  <link rel="stylesheet" href="/css/moleculer.css">
  <!-- endbuild -->
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700|Roboto Mono|Lato:300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  <!-- RSS
  <link rel="alternate" href="/atom.xml" title="Moleculer Go - Progressive microservices framework in Go">
  -->
  <!-- Open Graph -->
  <meta name="description" content="Broker lifecycleThis section describes what happens when the broker is starting &amp;amp; stopping. Starting logicThe broker starts transporter connecting but it doesn’t publish the local service list to">
<meta property="og:type" content="website">
<meta property="og:title" content="Lifecycle">
<meta property="og:url" content="https://gomicro.services/docs/0.1/lifecycle.html">
<meta property="og:site_name" content="Moleculer Go - Progressive microservices framework in Go">
<meta property="og:description" content="Broker lifecycleThis section describes what happens when the broker is starting &amp;amp; stopping. Starting logicThe broker starts transporter connecting but it doesn’t publish the local service list to">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://gomicro.services/docs/0.1/assets/lifecycle/broker-start.svg">
<meta property="og:image" content="https://gomicro.services/docs/0.1/assets/lifecycle/broker-stop.svg">
<meta property="og:updated_time" content="2019-03-22T00:10:38.625Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lifecycle">
<meta name="twitter:description" content="Broker lifecycleThis section describes what happens when the broker is starting &amp;amp; stopping. Starting logicThe broker starts transporter connecting but it doesn’t publish the local service list to">
<meta name="twitter:image" content="https://gomicro.services/docs/0.1/assets/lifecycle/broker-start.svg">
<meta name="twitter:site" content="MoleculerG">
  <!-- Google Analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99099811-1', 'auto');
  ga('send', 'pageview');
</script>


  <!-- Particles -->
  <script src="/js/buttons.js"></script>

</head>

<body>
  <div id="particles-js"></div>
  <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <h1 id="logo-wrap">
      <a href="/" id="logo">Moleculer</a>
    </h1>
    <nav id="main-nav">
      <a href="/docs/0.1/" class="main-nav-link">Documentation</a><a href="/modules.html" class="main-nav-link">Modules</a><a href="/support.html" class="main-nav-link">Support</a>
      <a href="https://github.com/moleculer-go/moleculer" class="main-nav-link">Github</a>
      <a href="https://gitter.im/moleculer-go/moleculer" class="main-nav-link">Chat</a>
      <a href="https://medium.com/moleculer" class="main-nav-link">Blog</a>
      <div id="search-input-wrap" class="on">
        <div id="search-input-icon">
          <i class="fa fa-search"></i>
        </div>
        <input type="search" id="search-input" placeholder="Search...">
      </div>
    </nav>
    <div id="lang-select-wrap" style="display: none">
      <label id="lang-select-label"><i class="fa fa-globe"></i><span>English</span></label>
      <select id="lang-select" data-canonical="">
        
          <option value="en" selected>English</option>
        
      </select>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

  <div id="container">
    <div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <article class="article-container" itemscope itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <header class="article-header">
                <h1 class="article-title" itemprop="name">Lifecycle</h1>
                <a href="https://github.com/moleculer-go/site/edit/master/source/docs/0.1/lifecycle.md" class="article-edit-link" title="Improve this doc"><i class="fa fa-pencil"></i></a>
              </header>
              <div class="article-content" itemprop="articleBody">
                <h2 id="Broker-lifecycle" class="article-heading"><a href="#Broker-lifecycle" class="headerlink" title="Broker lifecycle"></a>Broker lifecycle<a class="article-anchor" href="#Broker-lifecycle" aria-hidden="true"></a></h2><p>This section describes what happens when the broker is starting &amp; stopping.</p>
<h3 id="Starting-logic" class="article-heading"><a href="#Starting-logic" class="headerlink" title="Starting logic"></a>Starting logic<a class="article-anchor" href="#Starting-logic" aria-hidden="true"></a></h3><p>The broker starts transporter connecting but it doesn’t publish the local service list to remote nodes. When it’s done, it starts all services (calls service <code>started</code> handler). Once all services start successfully, broker publishes the local service list to remote nodes. Hence remote nodes send requests only after all local service are started properly.</p>
<div align="center"><br><img src="assets/lifecycle/broker-start.svg" alt="Broker starting lifecycle diagram"><br></div>

<blockquote class="note warn"><strong class="note-title">Avoid deadlocks</strong><p>Dead-locks can be made when two services wait for each other. E.g.: <code>users</code> service has <code>dependencies: [&quot;posts&quot;]</code> and <code>posts</code> service has <code>dependencies: [&quot;users&quot;]</code>. To avoid it, remove the concerned service from <code>dependencies</code> and use <code>this.waitForServices</code> method in <code>started</code> handler instead.</p>
</blockquote>
<h3 id="Stopping-logic" class="article-heading"><a href="#Stopping-logic" class="headerlink" title="Stopping logic"></a>Stopping logic<a class="article-anchor" href="#Stopping-logic" aria-hidden="true"></a></h3><p>When you call <code>broker.stop</code> or stop the process, at first broker publishes an empty service list to remote nodes, so they can route the requests to other instances instead of services under stopping. Next, the broker starts stopping all local services. After that, the transporter disconnects.</p>
<div align="center"><br><img src="assets/lifecycle/broker-stop.svg" alt="Broker stopping lifecycle diagram"><br></div>

<h2 id="Service-lifecycle" class="article-heading"><a href="#Service-lifecycle" class="headerlink" title="Service lifecycle"></a>Service lifecycle<a class="article-anchor" href="#Service-lifecycle" aria-hidden="true"></a></h2><p>This section describes what happens when a service is starting &amp; stopping and how you should use the lifecycle event handler.</p>
<h3 id="created-event-handler" class="article-heading"><a href="#created-event-handler" class="headerlink" title="created event handler"></a><code>created</code> event handler<a class="article-anchor" href="#created-event-handler" aria-hidden="true"></a></h3><p>It is triggered when the service instance is created (e.g.: at <code>broker.createService</code> or <code>broker.loadService</code>).<br>Use it to create other module instances (e.g. http server, database modules) and store them in <code>this</code>. </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    name: <span class="string">"www"</span>,</span><br><span class="line">    created() &#123;</span><br><span class="line">        <span class="comment">// Create HTTP server</span></span><br><span class="line">        <span class="keyword">this</span>.server = http.createServer(<span class="keyword">this</span>.httpHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This is a sync event handler. You <strong>cannot</strong> return a <code>Promise</code> and you <strong>cannot</strong> use <code>async/await</code>.</p>
</blockquote>
<h3 id="started-event-handler" class="article-heading"><a href="#started-event-handler" class="headerlink" title="started event handler"></a><code>started</code> event handler<a class="article-anchor" href="#started-event-handler" aria-hidden="true"></a></h3><p>It is triggered when the <code>broker.start</code> is called and the broker starts all local services. Use it to connect to database, listen servers…etc.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    name: <span class="string">"users"</span>,</span><br><span class="line">    <span class="keyword">async</span> started() &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">this</span>.db.connect();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MoleculerServerError(<span class="string">"Unable to connect to database."</span>, e.message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This is an async event handler. A <code>Promise</code> can be returned or use <code>async/await</code>.</p>
</blockquote>
<h3 id="stopped-event-handler" class="article-heading"><a href="#stopped-event-handler" class="headerlink" title="stopped event handler"></a><code>stopped</code> event handler<a class="article-anchor" href="#stopped-event-handler" aria-hidden="true"></a></h3><p>It is triggered when the <code>broker.stop</code> is called and the broker starts stopping all local services. Use it to close database connections, close sockets…etc.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    name: <span class="string">"users"</span>,</span><br><span class="line">    <span class="keyword">async</span> stopped() &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">this</span>.db.disconnect();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.warn(<span class="string">"Unable to stop database connection gracefully."</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This is an async event handler. A <code>Promise</code> can be returned or use <code>async/await</code>.</p>
</blockquote>

              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2019-03-22T00:10:38.625Z" itemprop="dateModified">Last updated: 2019-03-22</time>
                <a href="events.html" class="article-footer-prev" title="Events"><i class="fa fa-chevron-left"></i><span>Prev</span></a><a href="logging.html" class="article-footer-next" title="Logging"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
              
            </div>
          </div>
          <aside id="article-toc" role="navigation">
            <div id="article-toc-inner">
              <strong class="sidebar-title">Contents</strong>
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Broker-lifecycle"><span class="toc-text">Broker lifecycle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Starting-logic"><span class="toc-text">Starting logic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stopping-logic"><span class="toc-text">Stopping logic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-lifecycle"><span class="toc-text">Service lifecycle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#created-event-handler"><span class="toc-text">created event handler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#started-event-handler"><span class="toc-text">started event handler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stopped-event-handler"><span class="toc-text">stopped event handler</span></a></li></ol></li></ol>
              <a href="#" id="article-toc-top">Back to Top</a>
            </div>
          </aside>
        </div>
      </article>
      <aside id="sidebar" role="navigation">
  <div class="inner"><div class="version-selector"><select onchange="changeVersion(this)"><option value="docs/0.1"selected>v0.1</option></select></div><strong class="sidebar-title">Introduction</strong><a href="/docs/0.1/index.html" class="sidebar-link">What is Moleculer?</a><a href="/docs/0.1/usage.html" class="sidebar-link">Usage</a><a href="/docs/0.1/examples.html" class="sidebar-link">Examples</a><strong class="sidebar-title">Overview</strong><a href="/docs/0.1/broker.html" class="sidebar-link">Broker</a><a href="/docs/0.1/services.html" class="sidebar-link">Services</a><a href="/docs/0.1/actions.html" class="sidebar-link">Actions</a><a href="/docs/0.1/events.html" class="sidebar-link">Events</a><a href="/docs/0.1/lifecycle.html" class="sidebar-link current">Lifecycles</a><a href="/docs/0.1/logging.html" class="sidebar-link">Logging</a><a href="/docs/0.1/middlewares.html" class="sidebar-link">Middlewares</a><a href="/docs/0.1/networking.html" class="sidebar-link">Networking</a><a href="/docs/0.1/registry.html" class="sidebar-link">Discovery & Registry</a><a href="/docs/0.1/balancing.html" class="sidebar-link">Load balancing</a><a href="/docs/0.1/fault-tolerance.html" class="sidebar-link">Fault tolerance</a><a href="/docs/0.1/caching.html" class="sidebar-link">Caching</a><a href="/docs/0.1/validating.html" class="sidebar-link">Validating</a><a href="/docs/0.1/metrics.html" class="sidebar-link">Metrics & Tracing</a><a href="/docs/0.1/errors.html" class="sidebar-link">Errors</a><a href="/docs/0.1/runner.html" class="sidebar-link">Moleculer Runner</a><strong class="sidebar-title">Modules</strong><a href="/docs/0.1/moleculer-web.html" class="sidebar-link">API Gateway</a><a href="/docs/0.1/moleculer-repl.html" class="sidebar-link">REPL console</a><a href="/docs/0.1/moleculer-cli.html" class="sidebar-link">CLI Tool</a><a href="/docs/0.1/moleculer-db.html" class="sidebar-link">DB Adapters</a><a href="/modules.html" class="sidebar-link">All modules</a><strong class="sidebar-title">Miscellaneous</strong><a href="/docs/0.1/clustering.html" class="sidebar-link">Clustering</a><a href="/docs/0.1/deploying.html" class="sidebar-link">Deploying</a><a href="/docs/0.1/benchmark.html" class="sidebar-link">Benchmark</a><a href="/docs/0.1/faq.html" class="sidebar-link">FAQ</a><a href="/docs/0.1/contributing.html" class="sidebar-link">Contributing</a><strong class="sidebar-title">API</strong><a href="/docs/0.1/api/service-broker.html" class="sidebar-link">ServiceBroker</a><a href="/docs/0.1/api/service.html" class="sidebar-link">Service</a><a href="/docs/0.1/api/context.html" class="sidebar-link">Context</a><a href="/docs/0.1/api/protocol.html" class="sidebar-link">Protocol</a></div>
</aside>
    </div>
  </div>
</div>

    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      Copyright &copy; 2018-2019 <a href="https://github.com/pentateu" target="_blank">MoleculerGO</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>.
    </div>
    <div id="footer-links">
      <a href="https://gitter.im/moleculer-go/moleculer" class="footer-link" target="_blank"><i class="fa fa-comments-o"></i></a>
      <a href="https://twitter.com/MoleculerG" class="footer-link" target="_blank"><i class="fa fa-twitter"></i></a>
      <a href="https://github.com/moleculer-go/moleculer" class="footer-link" target="_blank"><i class="fa fa-github-alt"></i></a>
      <a href="https://stackoverflow.com/questions/tagged/moleculer-go" class="footer-link" target="_blank"><i class="fa fa-stack-overflow"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/docs/0.1/" class="mobile-nav-link">Documentation</a><a href="/modules.html" class="mobile-nav-link">Modules</a><a href="/support.html" class="mobile-nav-link">Support</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/moleculer-go/moleculer" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
      <div class="version-selector"><select onchange="changeVersion(this)"><option value="docs/0.1"selected>v0.1</option></select></div><strong class="mobile-nav-title">Introduction</strong><a href="/docs/0.1/index.html" class="mobile-nav-link">What is Moleculer?</a><a href="/docs/0.1/usage.html" class="mobile-nav-link">Usage</a><a href="/docs/0.1/examples.html" class="mobile-nav-link">Examples</a><strong class="mobile-nav-title">Overview</strong><a href="/docs/0.1/broker.html" class="mobile-nav-link">Broker</a><a href="/docs/0.1/services.html" class="mobile-nav-link">Services</a><a href="/docs/0.1/actions.html" class="mobile-nav-link">Actions</a><a href="/docs/0.1/events.html" class="mobile-nav-link">Events</a><a href="/docs/0.1/lifecycle.html" class="mobile-nav-link current">Lifecycles</a><a href="/docs/0.1/logging.html" class="mobile-nav-link">Logging</a><a href="/docs/0.1/middlewares.html" class="mobile-nav-link">Middlewares</a><a href="/docs/0.1/networking.html" class="mobile-nav-link">Networking</a><a href="/docs/0.1/registry.html" class="mobile-nav-link">Discovery & Registry</a><a href="/docs/0.1/balancing.html" class="mobile-nav-link">Load balancing</a><a href="/docs/0.1/fault-tolerance.html" class="mobile-nav-link">Fault tolerance</a><a href="/docs/0.1/caching.html" class="mobile-nav-link">Caching</a><a href="/docs/0.1/validating.html" class="mobile-nav-link">Validating</a><a href="/docs/0.1/metrics.html" class="mobile-nav-link">Metrics & Tracing</a><a href="/docs/0.1/errors.html" class="mobile-nav-link">Errors</a><a href="/docs/0.1/runner.html" class="mobile-nav-link">Moleculer Runner</a><strong class="mobile-nav-title">Modules</strong><a href="/docs/0.1/moleculer-web.html" class="mobile-nav-link">API Gateway</a><a href="/docs/0.1/moleculer-repl.html" class="mobile-nav-link">REPL console</a><a href="/docs/0.1/moleculer-cli.html" class="mobile-nav-link">CLI Tool</a><a href="/docs/0.1/moleculer-db.html" class="mobile-nav-link">DB Adapters</a><a href="/modules.html" class="mobile-nav-link">All modules</a><strong class="mobile-nav-title">Miscellaneous</strong><a href="/docs/0.1/clustering.html" class="mobile-nav-link">Clustering</a><a href="/docs/0.1/deploying.html" class="mobile-nav-link">Deploying</a><a href="/docs/0.1/benchmark.html" class="mobile-nav-link">Benchmark</a><a href="/docs/0.1/faq.html" class="mobile-nav-link">FAQ</a><a href="/docs/0.1/contributing.html" class="mobile-nav-link">Contributing</a><strong class="mobile-nav-title">API</strong><a href="/docs/0.1/api/service-broker.html" class="mobile-nav-link">ServiceBroker</a><a href="/docs/0.1/api/service.html" class="mobile-nav-link">Service</a><a href="/docs/0.1/api/context.html" class="mobile-nav-link">Context</a><a href="/docs/0.1/api/protocol.html" class="mobile-nav-link">Protocol</a>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en" selected>English</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- build:js build/js/main.js -->
<script src="/js/lang_select.js"></script>
<script src="/js/version_select.js"></script>
<script src="/js/scrollingelement.js"></script>
<script src="/js/toc.js"></script>
<script src="/js/mobile_nav.js"></script>
<!-- endbuild -->
<script src="https://cdn.jsdelivr.net/retinajs/1.3.0/retina.min.js" async></script>

<!-- Algolia -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
apiKey: '7d5514b7c3e161a428f04f33ba1bdab4',
indexName: 'moleculer',
inputSelector: '#search-input',
algoliaOptions: { 'facetFilters': ["version:0.1"] },
debug: false // Set debug to true if you want to inspect the dropdown
});
</script>


<!-- fastclick -->
<script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  FastClick.attach(document.body)
}, false)
</script>

<!-- Gitter Chat -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'moleculer-go/moleculer'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
</body>
</html>